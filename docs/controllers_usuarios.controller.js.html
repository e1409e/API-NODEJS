<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/usuarios.controller.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/usuarios.controller.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Este archivo contiene los controladores para la gestión de usuarios.
 * @description Cada función implementa la lógica de negocio para registrar, autenticar,
 * consultar, editar y eliminar usuarios, así como obtener información específica
 * como la contraseña o el nombre por cédula.
 * @author Eric
 * @version 1.0.0
 * @see {@link ../db.js} Para la configuración de la conexión a la base de datos.
 */

import { sql } from "../db.js";
import { toCapitalCase } from "../utilities/formatters.js"; // Importa la función de formateo

/**
 * @description Controlador para registrar un nuevo usuario en el sistema.
 * Valida la existencia previa del usuario por cédula y el rol proporcionado antes de la inserción.
 * Aplica formato "Capital Case" a los campos `nombre` y `apellido`.
 * @param {object} req - Objeto de solicitud de Express. Se espera que contenga en `req.body`:
 * - `nombre` (string): El nombre del usuario.
 * - `apellido` (string): El apellido del usuario.
 * - `cedula_usuario` (string): La cédula de identidad única del usuario.
 * - `password` (string): La contraseña del usuario (se recomienda hashing antes de enviar a la DB).
 * - `rol` (string): El rol asignado al usuario (ej. "administrador", "psicologo", "docente").
 * @param {object} res - Objeto de respuesta de Express.
 * @returns {Promise&lt;void>} Responde con un estado HTTP y un mensaje JSON.
 * @throws {Error} Si ocurre un error durante la interacción con la base de datos o la validación.
 * @method POST
 * @route /api/usuarios/registrar
 */
export const registrarUsuario = async (req, res) => {
  try {
    let { nombre, apellido, cedula_usuario, password, rol } = req.body;

    // Aplica formato Capital Case a nombre y apellido
    nombre = toCapitalCase(nombre);
    apellido = toCapitalCase(apellido);

    // **Validación de Rol (Recomendada):** Verifica que el 'rol' proporcionado sea uno de los valores permitidos.
    // Esto asegura que se cumpla con las restricciones de la base de datos (ej. un CHECK constraint).
    if (!["administrador", "psicologo", "docente"].includes(rol)) {
      return res.status(400).json({ error: "Rol inválido proporcionado." });
    }

    // **Verificación de Usuario Existente:** Consulta la base de datos para determinar si ya existe un usuario con la misma cédula.
    const usuarioExistente = await sql`
      SELECT * FROM usuarios WHERE cedula_usuario = ${cedula_usuario}
    `;

    // Si `usuarioExistente` contiene al menos un registro, significa que la cédula ya está en uso.
    if (usuarioExistente.length > 0) {
      return res.status(400).json({ error: "El usuario ya existe" });
    }

    // **Inserción del Nuevo Usuario:** Si el usuario no existe y el rol es válido, se procede a insertar el nuevo registro
    // en la tabla `usuarios` con todos los datos proporcionados, incluyendo el rol.
    await sql`
      INSERT INTO usuarios (nombre, apellido, cedula_usuario, password, rol)
      VALUES (${nombre}, ${apellido}, ${cedula_usuario}, ${password}, ${rol})
    `;

    // Responde con un estado 201 (Created) indicando que el usuario fue registrado exitosamente.
    res.status(201).json({ message: "Usuario registrado correctamente" });
  } catch (error) {
    // Captura y registra cualquier error ocurrido durante el proceso de registro.
    console.error("Error al registrar usuario:", error);
    // Responde con un estado 500 (Internal Server Error) y un mensaje genérico de error.
    res.status(500).json({ error: "Error al registrar usuario" });
  }
};

/**
 * @description Controlador para el inicio de sesión de un usuario.
 * Autentica al usuario verificando su cédula y contraseña.
 * @param {object} req - Objeto de solicitud de Express. Se espera que contenga en `req.body`:
 * - `cedula_usuario` (string): La cédula de identidad del usuario.
 * - `password` (string): La contraseña proporcionada por el usuario.
 * @param {object} res - Objeto de respuesta de Express.
 * @returns {Promise&lt;void>} Responde con un estado HTTP y un mensaje JSON con el resultado del inicio de sesión.
 * @throws {Error} Si ocurre un error durante la interacción con la base de datos.
 * @method POST
 * @route /api/usuarios/login
 */
export const iniciarSesion = async (req, res) => {
  try {
    const { cedula_usuario, password } = req.body;

    // **Búsqueda de Usuario y Autenticación:** Se busca al usuario en la base de datos
    // por su cédula y contraseña. También se selecciona el rol para ser devuelto en la respuesta.
    const usuario = await sql`
      SELECT id_usuario, nombre, apellido, cedula_usuario, rol FROM usuarios WHERE cedula_usuario = ${cedula_usuario} AND password = ${password} 
    `;

    // Si no se encuentra ningún usuario que coincida con ambas credenciales, se considera un fallo de autenticación.
    if (usuario.length === 0) {
      return res.status(401).json({ error: 'Credenciales inválidas', success: false });
    }

    // Si las credenciales son correctas, el usuario autenticado se encuentra en la primera posición del array de resultados.
    const usuarioLogueado = usuario[0];

    // Responde con un estado 200 (OK), indicando un inicio de sesión exitoso.
    // Incluye un mensaje, el estado de éxito, el rol del usuario y su ID.
    res.json({
      message: 'Inicio de sesión exitoso',
      success: true,
      rol: usuarioLogueado.rol,
      id_usuario: usuarioLogueado.id_usuario,
      // cedula_usuario: usuarioLogueado.cedula_usuario, // Esta línea está comentada, puede ser útil para depuración.
    });
  } catch (error) {
    // Captura y registra cualquier error ocurrido durante el proceso de inicio de sesión.
    console.error('Error al iniciar sesión:', error);
    // Responde con un estado 500 (Internal Server Error) y un mensaje genérico de error.
    res.status(500).json({ error: 'Error al iniciar sesión', success: false });
  }
};

/**
 * @description Controlador para obtener la contraseña de un usuario específico por su ID.
 * **NOTA DE SEGURIDAD:** Esta función expone información sensible. En un entorno de producción,
 * se DEBE implementar una capa de autenticación y autorización robusta (ej. verificar que
 * el usuario que realiza la solicitud es un administrador autorizado) para restringir su acceso.
 * @param {object} req - Objeto de solicitud de Express. Se espera que contenga en `req.params`:
 * - `id_usuario` (string | number): El ID del usuario cuya contraseña se desea obtener.
 * @param {object} res - Objeto de respuesta de Express.
 * @returns {Promise&lt;void>} Responde con un estado HTTP y un JSON que contiene la contraseña o un mensaje de error.
 * @throws {Error} Si ocurre un error durante la interacción con la base de datos.
 * @method GET
 * @route /api/usuarios/password/:id_usuario
 */
export const obtenerPasswordUsuario = async (req, res) => {
  try {
    const { id_usuario } = req.params;
    // **NOTA DE SEGURIDAD CRÍTICA:**
    // En un entorno de producción, es imprescindible añadir aquí una lógica de validación
    // de roles y permisos. Por ejemplo, verificar que el usuario autenticado que realiza
    // esta solicitud tiene rol de 'administrador' y está autorizado para ver la contraseña
    // de otros usuarios. La exposición directa de contraseñas es una vulnerabilidad mayor.

    // Consulta la base de datos para obtener únicamente el campo `password` del usuario por su ID.
    const usuario = await sql`
      SELECT password FROM usuarios WHERE id_usuario = ${id_usuario}
    `;

    // Si el usuario no es encontrado con el ID proporcionado, se devuelve un error 404.
    if (usuario.length === 0) {
      return res.status(404).json({ error: "Usuario no encontrado" });
    }
    // Si el usuario es encontrado, se responde con la contraseña.
    res.json({ password: usuario[0].password });
  } catch (error) {
    // Captura y registra cualquier error durante el proceso.
    console.error("Error al obtener contraseña:", error);
    // Responde con un estado 500 (Internal Server Error).
    res.status(500).json({ error: "Error al obtener contraseña" });
  }
};

/**
 * @description Controlador para obtener una lista de todos los usuarios registrados en el sistema.
 * @param {object} req - Objeto de solicitud de Express (no se esperan parámetros específicos).
 * @param {object} res - Objeto de respuesta de Express.
 * @returns {Promise&lt;void>} Responde con un estado HTTP y un array JSON de objetos de usuario.
 * @throws {Error} Si ocurre un error durante la interacción con la base de datos.
 * @method GET
 * @route /api/usuarios
 */
export const obtenerTodosLosUsuarios = async (req, res) => {
  try {
    // Realiza una consulta SQL para seleccionar todos los registros de la tabla `usuarios`.
    const usuarios = await sql`SELECT * FROM usuarios`;
    // Responde con un estado 200 (OK) y la lista de usuarios.
    res.json(usuarios);
  } catch (error) {
    // Captura y registra cualquier error.
    console.error("Error al obtener usuarios:", error);
    // Responde con un estado 500 (Internal Server Error).
    res.status(500).json({ error: "Error al obtener usuarios" });
  }
};

/**
 * @description Controlador para editar la información de un usuario existente.
 * Permite actualizar el nombre, apellido, cédula, contraseña y/o rol del usuario.
 * Aplica formato "Capital Case" a los campos `nombre` y `apellido` si se proporcionan.
 * @param {object} req - Objeto de solicitud de Express. Se espera que contenga:
 * - `req.params.id_usuario` (string | number): El ID del usuario a editar.
 * - `req.body`: Puede incluir cualquiera de los siguientes campos para actualizar:
 * - `nombre` (string, opcional)
 * - `apellido` (string, opcional)
 * - `cedula_usuario` (string, opcional)
 * - `password` (string, opcional)
 * - `rol` (string, opcional)
 * @param {object} res - Objeto de respuesta de Express.
 * @returns {Promise&lt;void>} Responde con un estado HTTP y un mensaje JSON.
 * @throws {Error} Si ocurre un error durante la interacción con la base de datos o la validación.
 * @method PUT
 * @route /api/usuarios/:id_usuario
 */
export const editarUsuario = async (req, res) => {
  try {
    const { id_usuario } = req.params;
    // Se extraen todos los campos posibles de `req.body`.
    let { nombre, apellido, cedula_usuario, password, rol } = req.body;

    // Aplica formato Capital Case a nombre y apellido si se proporcionan
    if (nombre) nombre = toCapitalCase(nombre);
    if (apellido) apellido = toCapitalCase(apellido);

    // **Verificación de Usuario Existente:** Se consulta la base de datos para asegurar que el usuario a editar realmente existe.
    const usuarioExistente = await sql`
      SELECT * FROM usuarios WHERE id_usuario = ${id_usuario}
    `;

    // Si el usuario no es encontrado, se devuelve un error 404.
    if (usuarioExistente.length === 0) {
      return res.status(404).json({ error: 'Usuario no encontrado' });
    }

    // **Validación de Rol (Opcional):** Si el campo 'rol' se proporciona en la solicitud de actualización,
    // se valida que sea uno de los valores permitidos para mantener la integridad de los datos.
    if (rol &amp;&amp; !['administrador', 'psicologo', 'docente'].includes(rol)) {
      return res.status(400).json({ error: 'Rol inválido proporcionado para actualización.' });
    }

    // **Actualización del Usuario:** Se invoca una función almacenada en PostgreSQL `editar_usuario`.
    // Es fundamental que esta función en la base de datos esté diseñada para recibir todos estos parámetros
    // y actualizar los campos correspondientes.
    await sql`
      SELECT editar_usuario(
        ${id_usuario},
        ${nombre},
        ${apellido},
        ${cedula_usuario},
        ${password},
        ${rol}
      )
    `;

    // Responde con un estado 200 (OK) y un mensaje de éxito.
    res.json({ message: 'Usuario actualizado correctamente' });
  } catch (error) {
    // Captura y registra cualquier error durante el proceso de edición.
    console.error('Error al editar usuario:', error);
    // Responde con un estado 500 (Internal Server Error).
    res.status(500).json({ error: 'Error al editar usuario' });
  }
};

/**
 * @description Controlador para eliminar un usuario existente del sistema.
 * @param {object} req - Objeto de solicitud de Express. Se espera que contenga en `req.params`:
 * - `id_usuario` (string | number): El ID del usuario a eliminar.
 * @param {object} res - Objeto de respuesta de Express.
 * @returns {Promise&lt;void>} Responde con un estado HTTP y un mensaje JSON.
 * @throws {Error} Si ocurre un error durante la interacción con la base de datos.
 * @method DELETE
 * @route /api/usuarios/:id_usuario
 */
export const eliminarUsuario = async (req, res) => {
  try {
    const { id_usuario } = req.params;

    // **Verificación de Usuario Existente:** Se verifica si el usuario a eliminar realmente existe en la base de datos.
    const usuarioExistente = await sql`
      SELECT * FROM usuarios WHERE id_usuario = ${id_usuario}
    `;

    // Si el usuario no es encontrado, se devuelve un error 404.
    if (usuarioExistente.length === 0) {
      return res.status(404).json({ error: "Usuario no encontrado" });
    }

    // **Eliminación del Usuario:** Se invoca una función almacenada en PostgreSQL `eliminar_usuario`
    // para remover el registro del usuario de la base de datos.
    await sql`
      SELECT eliminar_usuario(${id_usuario})
    `;

    // Responde con un estado 200 (OK) y un mensaje de éxito.
    res.json({ message: "Usuario eliminado correctamente" });
  } catch (error) {
    // Captura y registra cualquier error durante el proceso de eliminación.
    console.error("Error al eliminar usuario:", error);
    // Responde con un estado 500 (Internal Server Error).
    res.status(500).json({ error: "Error al eliminar usuario" });
  }
};

/**
 * @description Controlador para obtener la información detallada de un usuario por su ID.
 * @param {object} req - Objeto de solicitud de Express. Se espera que contenga en `req.params`:
 * - `id_usuario` (string | number): El ID del usuario a buscar.
 * @param {object} res - Objeto de respuesta de Express.
 * @returns {Promise&lt;void>} Responde con un estado HTTP y un objeto JSON del usuario.
 * @throws {Error} Si ocurre un error durante la interacción con la base de datos.
 * @method GET
 * @route /api/usuarios/:id_usuario
 */
export const obtenerUsuarioPorId = async (req, res) => {
  try {
    const { id_usuario } = req.params;
    // Realiza una consulta para obtener los campos relevantes de un usuario específico por su ID.
    const usuario = await sql`
      SELECT id_usuario, nombre, apellido, cedula_usuario, rol
      FROM usuarios
      WHERE id_usuario = ${id_usuario}
    `;
    // Si no se encuentra un usuario con el ID dado, se devuelve un error 404.
    if (usuario.length === 0) {
      return res.status(404).json({ error: "Usuario no encontrado" });
    }
    // Responde con un estado 200 (OK) y el primer (y único) resultado del usuario.
    res.json(usuario[0]);
  } catch (error) {
    // Captura y registra cualquier error.
    console.error("Error al obtener usuario por ID:", error);
    // Responde con un estado 500 (Internal Server Error).
    res.status(500).json({ error: "Error al obtener usuario por ID" });
  }
};

/**
 * @description Controlador para obtener el nombre y apellido de un usuario utilizando su cédula.
 * @param {object} req - Objeto de solicitud de Express. Se espera que contenga en `req.params`:
 * - `cedula_usuario` (string): La cédula del usuario cuyo nombre y apellido se desean obtener.
 * @param {object} res - Objeto de respuesta de Express.
 * @returns {Promise&lt;void>} Responde con un estado HTTP y un objeto JSON con el nombre y apellido del usuario.
 * @throws {Error} Si ocurre un error durante la interacción con la base de datos.
 * @method GET
 * @route /api/usuarios/cedula/:cedula_usuario/nombre
 */
export const obtenerNombrePorCedula = async (req, res) => {
  try {
    const { cedula_usuario } = req.params;
    // Realiza una consulta para obtener el nombre y apellido de un usuario por su cédula.
    const usuario = await sql`
      SELECT nombre, apellido FROM usuarios WHERE cedula_usuario = ${cedula_usuario}
    `;
    // Si no se encuentra un usuario con la cédula dada, se devuelve un error 404.
    if (usuario.length === 0) {
      return res.status(404).json({ error: "Usuario no encontrado" });
    }
    // Responde con un estado 200 (OK) y un objeto que contiene el nombre y apellido.
    res.json({ nombre: usuario[0].nombre, apellido: usuario[0].apellido });
  } catch (error) {
    // Captura y registra cualquier error.
    console.error("Error al obtener nombre por cédula:", error);
    // Responde con un estado 500 (Internal Server Error).
    res.status(500).json({ error: "Error al obtener nombre por cédula" });
  }
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="controllers_carreras.module_controller.html">controllers/carreras.controller</a></li><li><a href="controllers_citas.module_controller.html">controllers/citas.controller</a></li><li><a href="controllers_discapacidades.module_controller.html">controllers/discapacidades.controller</a></li><li><a href="controllers_facultades.module_controller.html">controllers/facultades.controller</a></li><li><a href="controllers_historialMedico.module_controller.html">controllers/historialMedico.controller</a></li><li><a href="controllers_incidencias.module_controller.html">controllers/incidencias.controller</a></li><li><a href="controllers_reportePsicologico.module_controller.html">controllers/reportePsicologico.controller</a></li><li><a href="controllers_representantes.module_controller.html">controllers/representantes.controller</a></li><li><a href="module-config.html">config</a></li><li><a href="module-db.html">db</a></li><li><a href="module-utilities_formatters.html">utilities/formatters</a></li><li><a href="routes_carreras.module_routes.html">routes/carreras.routes</a></li><li><a href="routes_citas.module_routes.html">routes/citas.routes</a></li><li><a href="routes_discapacidades.module_routes.html">routes/discapacidades.routes</a></li><li><a href="routes_estudiantes.module_routes.html">routes/estudiantes.routes</a></li><li><a href="routes_facultades.module_routes.html">routes/facultades.routes</a></li><li><a href="routes_historialMedico.module_routes.html">routes/historialMedico.routes</a></li><li><a href="routes_incidencias.module_routes.html">routes/incidencias.routes</a></li><li><a href="routes_reportePsicologico.module_routes.html">routes/reportePsicologico.routes</a></li><li><a href="routes_representantes.module_routes.html">routes/representantes.routes</a></li><li><a href="routes_usuarios.module_routes.html">routes/usuarios.routes</a></li><li><a href="validations_carreras.module_validations.html">validations/carreras.validations</a></li><li><a href="validations_citas.module_validations.html">validations/citas.validations</a></li><li><a href="validations_discapacidades.module_validations.html">validations/discapacidades.validations</a></li><li><a href="validations_estudiantes.module_validations.html">validations/estudiantes.validations</a></li><li><a href="validations_facultades.module_validations.html">validations/facultades.validations</a></li><li><a href="validations_historialMedico.module_validations.html">validations/historialMedico.validations</a></li><li><a href="validations_incidencias.module_validations.html">validations/incidencias.validations</a></li><li><a href="validations_reportePsicologico.module_validations.html">validations/reportePsicologico.validations</a></li><li><a href="validations_representantes.module_validations.html">validations/representantes.validations</a></li><li><a href="validations_usuarios.module_validations.html">validations/usuarios.validations</a></li></ul><h3>Namespaces</h3><ul><li><a href="validations_carreras.module_validations-carrerasValidations.html">carrerasValidations</a></li><li><a href="validations_citas.module_validations-citaValidations.html">citaValidations</a></li><li><a href="validations_discapacidades.module_validations-discapacidadValidations.html">discapacidadValidations</a></li><li><a href="validations_estudiantes.module_validations-estudianteValidations.html">estudianteValidations</a></li><li><a href="validations_facultades.module_validations-facultadesValidations.html">facultadesValidations</a></li><li><a href="validations_historialMedico.module_validations-historialMedicoValidations.html">historialMedicoValidations</a></li><li><a href="validations_incidencias.module_validations-incidenciasValidations.html">incidenciasValidations</a></li><li><a href="validations_reportePsicologico.module_validations-reportePsicologicoValidations.html">reportePsicologicoValidations</a></li><li><a href="validations_representantes.module_validations-representanteValidations.html">representanteValidations</a></li><li><a href="validations_usuarios.module_validations-usuarioValidations.html">usuarioValidations</a></li></ul><h3>Global</h3><ul><li><a href="global.html#DELETE">DELETE</a></li><li><a href="global.html#GET">GET</a></li><li><a href="global.html#POST">POST</a></li><li><a href="global.html#PUT">PUT</a></li><li><a href="global.html#app">app</a></li><li><a href="global.html#crearEstudiante">crearEstudiante</a></li><li><a href="global.html#editarEstudiante">editarEstudiante</a></li><li><a href="global.html#eliminarEstudiante">eliminarEstudiante</a></li><li><a href="global.html#obtenerEstudiantePorId">obtenerEstudiantePorId</a></li><li><a href="global.html#obtenerEstudiantes">obtenerEstudiantes</a></li><li><a href="global.html#sql">sql</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Tue Jul 01 2025 16:26:14 GMT-0400 (hora de Venezuela)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
